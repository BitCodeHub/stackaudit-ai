# GitHub Actions Workflow for Scheduled Health Checks
# Provides free monitoring via GitHub Actions cron jobs

name: Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggers

env:
  API_URL: https://api.stackaudit.ai
  FRONTEND_URL: https://stackaudit.ai
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check API Health
        id: api_health
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 30 "${{ env.API_URL }}/api/health")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "api_status=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "api_body=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::API health check failed with status $HTTP_CODE"
          fi
      
      - name: Check Frontend
        id: frontend_health
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${{ env.FRONTEND_URL }}")
          echo "frontend_status=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Frontend health check failed with status $HTTP_CODE"
          fi
      
      - name: Check API Latency
        id: api_latency
        run: |
          LATENCY=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 "${{ env.API_URL }}/api/health")
          LATENCY_MS=$(echo "$LATENCY * 1000" | bc)
          echo "latency_ms=$LATENCY_MS" >> $GITHUB_OUTPUT
          
          # Alert if latency > 2 seconds
          if (( $(echo "$LATENCY > 2" | bc -l) )); then
            echo "::warning::API latency is high: ${LATENCY_MS}ms"
          fi
      
      - name: Send Slack Alert on Failure
        if: failure()
        run: |
          curl -X POST "${{ env.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ”´ StackAudit Health Check Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*API Status:* ${{ steps.api_health.outputs.api_status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Frontend Status:* ${{ steps.frontend_health.outputs.frontend_status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*API Latency:* ${{ steps.api_latency.outputs.latency_ms }}ms"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                }
              ]
            }'
      
      - name: Create Issue on Persistent Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸ”´ Health Check Failure - ${new Date().toISOString()}`;
            const body = `
            ## Health Check Failed
            
            **Time:** ${new Date().toISOString()}
            **Run:** [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Results
            - API Status: ${{ steps.api_health.outputs.api_status }}
            - Frontend Status: ${{ steps.frontend_health.outputs.frontend_status }}
            - API Latency: ${{ steps.api_latency.outputs.latency_ms }}ms
            
            ### API Response
            \`\`\`json
            ${{ steps.api_health.outputs.api_body }}
            \`\`\`
            
            ---
            Auto-generated by GitHub Actions health check workflow.
            `;
            
            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'health-check,automated',
              state: 'open'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check', 'automated', 'bug']
              });
            }

  ssl-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check SSL Certificate
        id: ssl_check
        run: |
          # Get certificate expiry date
          EXPIRY=$(echo | openssl s_client -servername stackaudit.ai -connect stackaudit.ai:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
          
          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          echo "expiry_date=$EXPIRY" >> $GITHUB_OUTPUT
          
          if [ $DAYS_LEFT -lt 14 ]; then
            echo "::error::SSL certificate expires in $DAYS_LEFT days!"
          elif [ $DAYS_LEFT -lt 30 ]; then
            echo "::warning::SSL certificate expires in $DAYS_LEFT days"
          fi
      
      - name: Alert on Expiring Certificate
        if: ${{ steps.ssl_check.outputs.days_left < 14 }}
        run: |
          curl -X POST "${{ env.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âš ï¸ SSL Certificate Expiring Soon",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Domain:* stackaudit.ai"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Days Left:* ${{ steps.ssl_check.outputs.days_left }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Expires:* ${{ steps.ssl_check.outputs.expiry_date }}"
                    }
                  ]
                }
              ]
            }'
